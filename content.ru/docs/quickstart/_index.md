---
title: Начало работы
type: docs
---
# Начало работы

## Предисловие

Данный раздел описывает способ сконфигурировать, запустить и проверить бота локально в связке с локальным Alertmanager. Статья дает общее представление о первостепенных конфигурационных параметрах и способах интеграции, но не более того. Для запуска бота в реальной системе мониторинга и тонкой конфигурации обратитесь к соответствующим разделам.

## 1. Создание бота
Перед тем как запустить приложение необходимо создать нового бота в Telegram. Для этого вам нужно написать [@BotFather](https://t.me/botfather) и выполнить шаги описанные в [официальном руководстве](https://core.telegram.org/bots#creating-a-new-bot). Сохраните полученный авторизационный токен, он пригодится.

## 2. Настройте каналы
Создайте файл конфигурации `appsettings.json` ([пример](/)) и пропишите необходимые каналы в блоке `Alerting.Channels.Store.Predefined`. Канал состоит из имени и опционального описания.

{{< hint info >}}
Имя канала может состоять только из латинских букв и цифр, также допускается наличие разделителя '-', например _my-channel_.
{{< /hint >}}

Пример заданного блока представлен ниже.

{{< details "Каналы - appsettings.json" >}}
```
{ 
  "Alerting": {
    "Channels": {
      "Store": {
        "Predefined": [
          {
            "Name": "defaul",
            "Description": "Канал по умолчанию" 
          },
          {
            "Name": "infrastructure",
            "Description": "Канал инфраструктуры"
          }
        ]
      }
    }
  }
}
```
{{< /details >}}

## 3. Настройте хранилище для подписок
Хранилище необходимо для того чтобы бот запоминал какие чаты и пользователи телеграма подписаны на какие каналы, и при этом не терял это состояние при перезапуске. Подробнее про хранилища можно прочитать в [соответствующем разделе](#).

Самый простой вариант - использовать локальное хранилище на диске. Пример конфигурации представлен ниже.
{{< details "Подписки - appsettings.json" >}}
```
{ 
  "Alerting": {
    "Channels": {...},
    "Subscriptions": {
      "Store": {
        "Faster": {
          "Directory": ".storage"
        }
      }
    }
  }
}
```
{{< /details >}}

## 4. Настройте перечень доверенных пользователей
По умолчанию бот взаимодействует только с теми пользователями, чьи идентификаторы внесены в доверенный список. Это сделано для того чтобы любой пользователь телеграм не мог получить информацию из системы мониторинга.

Фильтрация работает именно по идентификатору пользователя, а не по username, т.к. username может быть изменен пользователем.
{{< hint info >}}
Чтобы узнать свой идентификатор в Telegram можно воспользоваться специальным ботом [@jsondumpbot](https://t.me/jsondumpbot) и скопировать идентификатор из поля `message.from.id`.
{{< /hint >}}

Пример секции конфигурации представлен ниже
{{< details "Конфигурация бота - appsettings.json" >}}
```
{ 
    {...},
    "Bot": { 
        "Authorization": {
            "TrustedUsers": {
                "AdministratorIds": [
                    1235522, 
                    5322455 
                ]
            }
        }
    }
}
```
{{< /details >}}

Опционально также можно [сконфигурировать подключение через прокси](#).

## 5. Установите адрес обратного вызова (опцинально)
Приложение обрабатывает события Telegram через callback-вызов. Это реализовано с целью улучшения возможностей отладки и поиска ошибок в приложении. По умолчанию адресом обратного вызова является `http://localhost:5000`. В случае, если приложение размещается на другом порте или же
в контейнеризованной среде (Docker, Kubernetes) необходимо его изменить.

Пример секции конфигурации обратного вызова
{{< details "Конфигурация обратного вызова - appsettings.json" >}}
```
{ 
  {...},
  "Clients": {
    "Callback": {
      "BaseUrl": "http://localhost:5000",
    }
  }
}
```
{{< /details >}}

## 6. Запустите приложение

Поддерживается несколько вариантов запуска. Для примера рассмотрим один из самых тривиальных - запуск через docker-compose. Сохраните созданный на предыдущих этапах файл appsettings.json и создайте файл docker-compose.yaml со следующим содержимым, заменив `{TOKEN}` на токен полученный от @BotFather. 

```
version: '3.7'

services:
  zeus:
    image: docker.pkg.github.com/btshft/zeus/zeus-bot:1.0.0-preview.c2083fa
    ports:
      - 5050:80
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      Bot__Token: {TOKEN}
    volumes:
      - type: bind
        source: ./appsettings.json
        target: /app/appsettings.Production.json
```

Запустите приложение с помощью команды `docker-compose up` и убедитесь в отсутствии ошибок в логе.
Попробуйте подписаться на один из заданных каналов с помощью команды `/subscribe {channel}`, где вместо `{channel}` имя одного из каналов заданных на втором этапе. 

## 7. Интегрируйте бота с Alertmanager

Отредактируйте конфигурацию Alertmanager и добавьте новых receiver'ов. Например так, заменив {channel} на нужный.
```
route:
  receiver: 'my-receiver'

receivers:
  - name: 'my-receiver'
    webhook_configs:
    - send_resolved: true
      url: 'http://localhost:5000/api/v1.0/webhook/alerts/{channel}'
```

## 8. Проверьте отправку уведомлений

Проверьте корректность полученного результата отправив тестовое уведомление одним из способов:
- [Отправка уведомления через Swagger](#)
- [Отправка уведомления через AlertManager API](#)

## Далее
- [Кастомизация шаблонов](#)
- [Способы развертывания бота](#)